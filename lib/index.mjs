var L=Object.defineProperty;var i=(t,e)=>L(t,"name",{value:e,configurable:!0});import x from"cross-fetch";var f;(function(t){t.Apple="apple",t.Github="github",t.Google="google",t.Facebook="facebook",t.LinkedIn="linkedin"})(f||(f={}));var d;(function(t){t.Code="code",t.Token="token"})(d||(d={}));var p=i(()=>typeof window<"u","hasWindow"),m=i(t=>{let e=t.trim();return e[e.length-1]==="/"&&(e=e.slice(0,-1)),e},"trimURL"),k=i(()=>p()?window.crypto||window.msCrypto:null,"getCrypto"),S=i(()=>{let t=k();return t&&t.subtle||t.webkitSubtle},"getCryptoSubtle"),h=i(()=>{let t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_~.",e="",r=k();return r&&Array.from(r.getRandomValues(new Uint8Array(43))).forEach(n=>e+=t[n%t.length]),e},"createRandomString"),c=i(t=>p()?btoa(t):Buffer.from(t).toString("base64"),"encode");var v=i(t=>Object.keys(t).filter(e=>typeof t[e]<"u").map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(t[e])}`).join("&"),"createQueryParams"),E=i(async t=>{let e=S().digest({name:"SHA-256"},new TextEncoder().encode(t));return window.msCrypto?new Promise((r,s)=>{e.oncomplete=n=>{r(n.target.result)},e.onerror=n=>{s(n.error)},e.onabort=()=>{s(new Error("The digest operation was aborted"))}}):await e},"sha256"),O=i(t=>{let e={"+":"-","/":"_","=":""};return t.replace(/[+/=]/g,r=>e[r])},"urlEncodeB64");var $=i(t=>{let e=new Uint8Array(t);return O(window.btoa(String.fromCharCode(...Array.from(e))))},"bufferToBase64UrlEncoded"),U=i((t,e,r=60)=>new Promise((s,n)=>{let o=window.document.createElement("iframe");o.setAttribute("id","authorizer-iframe"),o.setAttribute("width","0"),o.setAttribute("height","0"),o.style.display="none";let a,R=i(()=>{window.document.body.contains(o)&&(window.document.body.removeChild(o),window.removeEventListener("message",a,!1))},"removeIframe"),T=setTimeout(()=>{R()},r*1e3);a=i(function(u){if(u.origin!==e||!u.data||!u.data.response)return;let b=u.source;b&&b.close(),u.data.response.error?n(u.data.response):s(u.data.response),clearTimeout(T),window.removeEventListener("message",a,!1),setTimeout(R,2*1e3)},"iframeEventHandler"),window.addEventListener("message",a,!1),window.document.body.appendChild(o),o.setAttribute("src",t)}),"executeIframe");var w="id email email_verified given_name family_name middle_name nickname preferred_username picture signup_methods gender birthdate phone_number phone_number_verified roles created_at updated_at is_multi_factor_auth_enabled app_data",l=`message access_token expires_in refresh_token id_token should_show_email_otp_screen should_show_mobile_otp_screen user {${w}}`,y=i(()=>p()?window.fetch:x,"getFetcher"),g=class{constructor(e){if(!e)throw new Error("Configuration is required");if(this.config=e,!e.authorizerURL&&!e.authorizerURL.trim())throw new Error("Invalid authorizerURL");if(e.authorizerURL&&(this.config.authorizerURL=m(e.authorizerURL)),!e.redirectURL&&!e.redirectURL.trim())throw new Error("Invalid redirectURL");this.config.redirectURL=m(e.redirectURL),this.config.extraHeaders={...e.extraHeaders||{},"x-authorizer-url":this.config.authorizerURL,"Content-Type":"application/json"},this.config.clientID=e.clientID.trim()}authorize=async e=>{if(!p())return this.errorResponse(new Error("this feature is only supported in browser"));let r=["openid","profile","email"];e.use_refresh_token&&r.push("offline_access");let s={redirect_uri:this.config.redirectURL,response_mode:e.response_mode||"web_message",state:c(h()),nonce:c(h()),response_type:e.response_type,scope:r.join(" "),client_id:this.config.clientID};if(e.response_type===d.Code){this.codeVerifier=h();let o=await E(this.codeVerifier),a=$(o);s.code_challenge=a}let n=`${this.config.authorizerURL}/authorize?${v(s)}`;if(s.response_mode!=="web_message")return window.location.replace(n),this.okResponse(void 0);try{let o=await U(n,this.config.authorizerURL,60);if(e.response_type===d.Code){let a=await this.getToken({code:o.code});return a.ok?this.okResponse(a.response):this.errorResponse(a.error)}return this.okResponse(o)}catch(o){return o.error&&window.location.replace(`${this.config.authorizerURL}/app?state=${c(JSON.stringify(this.config))}&redirect_uri=${this.config.redirectURL}`),this.errorResponse(o)}};browserLogin=async()=>{try{let e=await this.getSession();return e.ok?this.okResponse(e.response):this.errorResponse(e.error)}catch(e){return p()?(window.location.replace(`${this.config.authorizerURL}/app?state=${c(JSON.stringify(this.config))}&redirect_uri=${this.config.redirectURL}`),this.errorResponse(e)):{ok:!1,response:void 0,error:new Error("browserLogin is only supported for browsers")}}};forgotPassword=async e=>{e.state||(e.state=c(h())),e.redirect_uri||(e.redirect_uri=this.config.redirectURL);try{let r=await this.graphqlQuery({query:"mutation forgotPassword($data: ForgotPasswordInput!) {	forgot_password(params: $data) { message } }",variables:{data:e}});return this.okResponse(r==null?void 0:r.forgot_password)}catch(r){return this.errorResponse(r)}};getMetaData=async()=>{try{let e=await this.graphqlQuery({query:"query { meta { version is_google_login_enabled is_facebook_login_enabled is_github_login_enabled is_linkedin_login_enabled is_apple_login_enabled is_twitter_login_enabled is_microsoft_login_enabled is_email_verification_enabled is_basic_authentication_enabled is_magic_link_login_enabled is_sign_up_enabled is_strong_password_enabled } }"});return this.okResponse(e.meta)}catch(e){return this.errorResponse(e)}};getProfile=async e=>{try{let r=await this.graphqlQuery({query:`query {	profile { ${w} } }`,headers:e});return this.okResponse(r.profile)}catch(r){return this.errorResponse(r)}};getSession=async(e,r)=>{try{let s=await this.graphqlQuery({query:`query getSession($params: SessionQueryInput){session(params: $params) { ${l} } }`,headers:e,variables:{params:r}});return this.okResponse(s.session)}catch(s){return this.errorResponse(s)}};getToken=async e=>{if(e.grant_type||(e.grant_type="authorization_code"),e.grant_type==="refresh_token"&&!e.refresh_token)return this.errorResponse(new Error("Invalid refresh_token"));if(e.grant_type==="authorization_code"&&!this.codeVerifier)return this.errorResponse(new Error("Invalid code verifier"));let r={client_id:this.config.clientID,code:e.code||"",code_verifier:this.codeVerifier||"",grant_type:e.grant_type||"",refresh_token:e.refresh_token||""};try{let n=await y()(`${this.config.authorizerURL}/oauth/token`,{method:"POST",body:JSON.stringify(r),headers:{...this.config.extraHeaders},credentials:"include"}),o=await n.json();return n.status>=400?this.errorResponse(new Error(o)):this.okResponse(o)}catch(s){return this.errorResponse(s)}};login=async e=>{try{let r=await this.graphqlQuery({query:`
					mutation login($data: LoginInput!) { login(params: $data) { ${l}}}
				`,variables:{data:e}});return this.okResponse(r.login)}catch(r){return this.errorResponse(new Error(r))}};logout=async e=>{try{let r=await this.graphqlQuery({query:" mutation { logout { message } } ",headers:e});return this.okResponse(r.response)}catch(r){return console.error(r),this.errorResponse(r)}};magicLinkLogin=async e=>{try{e.state||(e.state=c(h())),e.redirect_uri||(e.redirect_uri=this.config.redirectURL);let r=await this.graphqlQuery({query:`
					mutation magicLinkLogin($data: MagicLinkLoginInput!) { magic_link_login(params: $data) { message }}
				`,variables:{data:e}});return this.okResponse(r.magic_link_login)}catch(r){return this.errorResponse(r)}};oauthLogin=async(e,r,s,n)=>{let o=n;if(o||(o=c(h())),!Object.values(f).includes(e))throw new Error(`only following oauth providers are supported: ${Object.values(e).toString()}`);if(!p())throw new Error("oauthLogin is only supported for browsers");r&&r.length&&(o+=`&roles=${r.join(",")}`),window.location.replace(`${this.config.authorizerURL}/oauth_login/${e}?redirect_uri=${s||this.config.redirectURL}&state=${o}`)};resendOtp=async e=>{try{let r=await this.graphqlQuery({query:`
					mutation resendOtp($data: ResendOTPRequest!) { resend_otp(params: $data) { message }}
				`,variables:{data:e}});return this.okResponse(r.resend_otp)}catch(r){return this.errorResponse(r)}};resetPassword=async e=>{try{let r=await this.graphqlQuery({query:"mutation resetPassword($data: ResetPasswordInput!) {	reset_password(params: $data) { message } }",variables:{data:e}});return this.okResponse(r.reset_password)}catch(r){return this.errorResponse(r)}};revokeToken=async e=>{if(!e.refresh_token&&!e.refresh_token.trim())return this.errorResponse(new Error("Invalid refresh_token"));let n=await(await y()(`${this.config.authorizerURL}/oauth/revoke`,{method:"POST",headers:{...this.config.extraHeaders},body:JSON.stringify({refresh_token:e.refresh_token,client_id:this.config.clientID})})).json();return this.okResponse(n)};signup=async e=>{try{let r=await this.graphqlQuery({query:`
					mutation signup($data: SignUpInput!) { signup(params: $data) { ${l}}}
				`,variables:{data:e}});return this.okResponse(r.signup)}catch(r){return this.errorResponse(r)}};updateProfile=async(e,r)=>{try{let s=await this.graphqlQuery({query:"mutation updateProfile($data: UpdateProfileInput!) {	update_profile(params: $data) { message } }",headers:r,variables:{data:e}});return this.okResponse(s.update_profile)}catch(s){return this.errorResponse(new Error(s))}};deactivateAccount=async e=>{try{let r=await this.graphqlQuery({query:"mutation deactivateAccount { deactivate_account { message } }",headers:e});return this.okResponse(r.deactivate_account)}catch(r){return this.errorResponse(r)}};validateJWTToken=async e=>{try{let r=await this.graphqlQuery({query:"query validateJWTToken($params: ValidateJWTTokenInput!){validate_jwt_token(params: $params) { is_valid claims } }",variables:{params:e}});return this.okResponse(r.validate_jwt_token)}catch(r){return this.errorResponse(r)}};validateSession=async e=>{try{let r=await this.graphqlQuery({query:`query validateSession($params: ValidateSessionInput){validate_session(params: $params) { is_valid user { ${w} } } }`,variables:{params:e}});return this.okResponse(r.validate_session)}catch(r){return this.errorResponse(r)}};verifyEmail=async e=>{try{let r=await this.graphqlQuery({query:`
					mutation verifyEmail($data: VerifyEmailInput!) { verify_email(params: $data) { ${l}}}
				`,variables:{data:e}});return this.okResponse(r.verify_email)}catch(r){return this.errorResponse(r)}};resendVerifyEmail=async e=>{try{let r=await this.graphqlQuery({query:`
					mutation resendVerifyEmail($data: ResendVerifyEmailInput!) { resend_verify_email(params: $data) { message }}
				`,variables:{data:e}});return this.okResponse(r.verify_email)}catch(r){return this.errorResponse(r)}};verifyOtp=async e=>{try{let r=await this.graphqlQuery({query:`
					mutation verifyOtp($data: VerifyOTPRequest!) { verify_otp(params: $data) { ${l}}}
				`,variables:{data:e}});return this.okResponse(r.verify_otp)}catch(r){return this.errorResponse(r)}};graphqlQuery=async e=>{let n=await(await y()(`${this.config.authorizerURL}/graphql`,{method:"POST",body:JSON.stringify({query:e.query,variables:e.variables||{}}),headers:{...this.config.extraHeaders,...e.headers||{}},credentials:"include"})).json();if(n.errors&&n.errors.length)throw console.error(n.errors),new Error(n.errors[0].message);return n.data};errorResponse=e=>({ok:!1,response:void 0,error:e});okResponse=e=>({ok:!0,response:e,error:void 0})};i(g,"Authorizer");export{g as Authorizer,f as OAuthProviders,d as ResponseTypes};
